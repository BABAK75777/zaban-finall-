# HTTPS Implementation for Shadow Microphone - Complete Guide

## Secure Context Rule Explanation

Browser microphone APIs (`navigator.mediaDevices.getUserMedia()` and `MediaRecorder`) require a **secure context** as defined by the Web Security specification. Browsers treat `localhost` and `127.0.0.1` as special secure exceptions for development convenience, but **plain HTTP over LAN IPs (192.168.x.x) is NOT considered secure**. This is enforced browser security behavior that cannot be bypassed with JavaScript, React code, or permission changes. The only solution is to serve the frontend over HTTPS, which provides the required secure context for microphone access on LAN IPs.

---

## Exact Code: vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// HTTPS certificate paths (generated by mkcert)
const CERT_DIR = path.resolve(__dirname, 'certs');
const KEY_PATH = path.join(CERT_DIR, 'localhost+2-key.pem');
const CERT_PATH = path.join(CERT_DIR, 'localhost+2.pem');

// Check if certificates exist
const hasCertificates = fs.existsSync(KEY_PATH) && fs.existsSync(CERT_PATH);

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: 3000,
    // Enable HTTPS if certificates are available
    ...(hasCertificates && {
      https: {
        key: fs.readFileSync(KEY_PATH),
        cert: fs.readFileSync(CERT_PATH),
      },
    }),
    // Proxy API requests to backend
    proxy: {
      '/api': {
        target: 'http://192.168.86.190:3001',
        changeOrigin: true,
        secure: false,
        // Rewrite path: /api/health -> /health
        rewrite: (path) => path.replace(/^\/api/, ''),
      },
    },
  },
});
```

**Key Points:**
- `server.host: true` - Enables LAN access
- `server.port: 3000` - Frontend port
- `server.https` - Auto-enabled when certificates exist
- `server.proxy['/api']` - Proxies `/api/*` to backend, removes `/api` prefix

---

## mkcert Setup Steps (Windows)

### Step 1: Install mkcert

**Option A: Chocolatey (recommended)**
```powershell
choco install mkcert
```

**Option B: Winget**
```powershell
winget install FiloSottile.mkcert
```

**Option C: Manual Download**
1. Download from: https://github.com/FiloSottile/mkcert/releases
2. Extract `mkcert-v1.4.4-windows-amd64.exe` to a folder in your PATH
3. Rename to `mkcert.exe`

### Step 2: Install Local CA (one-time)

```powershell
mkcert -install
```

**Expected output:**
```
Created a new local CA at "C:\Users\YourName\AppData\Local\mkcert" 
The local CA is now installed in the system trust store! âš¡
```

### Step 3: Generate Certificates

```powershell
cd D:\app\zaban\zaban2

# Create certs directory
mkdir certs

# Generate certificate for localhost, 127.0.0.1, and LAN IP
mkcert -key-file certs/localhost+2-key.pem -cert-file certs/localhost+2.pem localhost 127.0.0.1 192.168.86.190
```

**Expected output:**
```
Created a new certificate valid for the following names ðŸ“œ
 - "localhost"
 - "127.0.0.1"
 - "192.168.86.190"

The certificate is at "certs/localhost+2.pem" and the key at "certs/localhost+2-key.pem" âœ…
```

**Note:** Replace `192.168.86.190` with your actual LAN IP if different.

### Step 4: Verify .gitignore

The `certs/` directory should already be in `.gitignore`. Verify:
```powershell
cat .gitignore | findstr certs
```

If not present, add it:
```powershell
echo "certs/" >> .gitignore
```

---

## Test Checklist

### âœ… Test 1: Start Backend

```powershell
cd D:\app\zaban\zaban2\backend
npm run dev
```

**Expected:** Backend running on `http://192.168.86.190:3001` (or `http://localhost:3001`)

**Verification:**
- Console shows: `Server running on port 3001`
- Test: `curl http://192.168.86.190:3001/health` â†’ `{"ok":true}`

---

### âœ… Test 2: Start Frontend

```powershell
cd D:\app\zaban\zaban2
npm run dev -- --host 0.0.0.0 --port 3000
```

**Expected output:**
```
VITE v5.x.x  ready in xxx ms

âžœ  Local:   https://localhost:3000/
âžœ  Network: https://192.168.86.190:3000/
```

**Verification:**
- âœ… URLs show `https://` (not `http://`)
- âœ… Both localhost and LAN IP are HTTPS
- âœ… If you see HTTP URLs, certificates are missing - check `certs/` directory

---

### âœ… Test 3: Desktop Test (LAN IP)

**Steps:**
1. Open `https://192.168.86.190:3000` in browser
2. **Accept certificate warning** (first time only):
   - Click "Advanced" or "Show Details"
   - Click "Proceed to 192.168.86.190 (unsafe)" or similar
3. Browser prompts for microphone permission â†’ **Allow**
4. Click **Shadow** button
5. Recording starts successfully

**Expected Results:**
- âœ… **NO** "Microphone API not available" message in console
- âœ… Console shows: `[SHADOW] Starting recording...`
- âœ… Microphone permission prompt appears
- âœ… Recording works (can record and playback)
- âœ… Network tab shows requests to `/api/*` (same origin, HTTPS)

**Console Verification:**
```
[API Base] Development mode: {
  pageHostname: "192.168.86.190",
  pageProtocol: "https:",
  apiBase: "/api",
  note: "Using relative /api paths (proxied by Vite to http://192.168.86.190:3001)"
}
```

**Network Tab Verification:**
- Request URL: `https://192.168.86.190:3000/api/health`
- Status: `200 OK`
- Type: `fetch` or `xhr`
- No CORS errors
- No mixed-content warnings

---

### âœ… Test 4: Phone Test

**Steps:**
1. On phone browser, open `https://192.168.86.190:3000`
2. **Accept certificate warning**:
   - Tap "Advanced" or "Details"
   - Tap "Proceed to 192.168.86.190" or "Continue"
3. Browser prompts for microphone permission â†’ **Allow**
4. Click **Shadow** button
5. Recording works

**Expected Results:**
- âœ… Shadow recording works on phone
- âœ… No "Microphone API not available" error
- âœ… Microphone permission prompt appears
- âœ… Recording starts successfully
- âœ… API calls work (Hear AI also works)

---

### âœ… Test 5: Localhost Test

**Steps:**
1. Open `http://localhost:3000` in browser
   - OR `https://localhost:3000` (both work)
2. Click **Shadow** button
3. Recording works

**Expected Results:**
- âœ… Shadow works on localhost (secure context exception)
- âœ… No certificate warning on HTTP localhost (browser exception)
- âœ… Recording starts successfully
- âœ… API calls work

---

## Troubleshooting

### Issue: Vite shows HTTP URLs instead of HTTPS

**Symptoms:**
- Console shows: `âžœ  Local:   http://localhost:3000/`
- Network tab shows HTTP protocol

**Solution:**
1. Check certificates exist: `ls certs/` (should show both `.pem` files)
2. Verify file names: `localhost+2-key.pem` and `localhost+2.pem`
3. Check directory is `certs/` (not `.cert/`)
4. Restart Vite dev server after generating certificates

---

### Issue: "Certificate not trusted" warning

**Symptoms:**
- Browser shows "Your connection is not private"
- Red lock icon in address bar

**Solution:**
1. Run `mkcert -install` again
2. Restart browser completely
3. Clear browser cache if needed
4. On first visit, click "Advanced" â†’ "Proceed" (expected behavior)

---

### Issue: "Microphone API not available" still appears

**Symptoms:**
- Error message persists after HTTPS setup

**Solution:**
1. Verify URL is `https://...` (not `http://...`)
2. Check browser permissions: Settings â†’ Site Settings â†’ Microphone â†’ Allow
3. Check console for specific error messages
4. Verify certificate is trusted (no red lock icon)
5. Try incognito/private mode to reset permissions

---

### Issue: API calls fail (404 or CORS)

**Symptoms:**
- Network tab shows 404 or CORS errors
- API requests fail

**Solution:**
1. Verify backend is running on `http://192.168.86.190:3001`
2. Check Vite proxy target matches backend address
3. Verify API client uses `/api` paths (check console logs)
4. Test backend directly: `curl http://192.168.86.190:3001/health`

---

## Summary

âœ… **HTTPS enabled** on Vite dev server (when certificates present)  
âœ… **Proxy configured** `/api/*` â†’ `http://192.168.86.190:3001`  
âœ… **API client** uses relative `/api` paths in dev  
âœ… **Backend unchanged** (stays HTTP)  
âœ… **Shadow works** on LAN IP via HTTPS  
âœ… **Backward compatible** (localhost still works on HTTP)

**Result:** Shadow microphone recording now works on `https://192.168.86.190:3000` from any device on the LAN! ðŸŽ¤âœ…

