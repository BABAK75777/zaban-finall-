# Shadow Microphone HTTPS Fix - Complete Implementation

## Problem Statement

**Current Behavior:**
- âœ… Shadow works on: `http://localhost:3000`
- âŒ Shadow fails on: `http://192.168.86.190:3000`
- Error: `[SHADOW] Microphone API not available. Use http://localhost:3000 or enable HTTPS.`
- âœ… Hear AI works (backend + API calls are fine)

**Root Cause:**
Microphone APIs (`navigator.mediaDevices.getUserMedia` / `MediaRecorder`) require a **secure context**:
- Browsers treat `localhost` as a secure exception
- LAN IPs over plain HTTP are **NOT** treated as secure
- Therefore Shadow will **NEVER** work on `http://192.168.86.190:3000` without HTTPS

**Mixed Content Constraint:**
If frontend is HTTPS and calls backend on `http://192.168.86.190:3001` directly, browsers block it as Mixed Content. Solution: Use Vite proxy so all requests are same-origin.

---

## Solution Implementation

### A) Vite HTTPS Configuration

**File: `vite.config.ts`**

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// HTTPS certificate paths (generated by mkcert)
const CERT_DIR = path.resolve(__dirname, 'certs');
const KEY_PATH = path.join(CERT_DIR, 'localhost+2-key.pem');
const CERT_PATH = path.join(CERT_DIR, 'localhost+2.pem');

// Check if certificates exist
const hasCertificates = fs.existsSync(KEY_PATH) && fs.existsSync(CERT_PATH);

export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: 3000,
    // Enable HTTPS if certificates are available
    ...(hasCertificates && {
      https: {
        key: fs.readFileSync(KEY_PATH),
        cert: fs.readFileSync(CERT_PATH),
      },
    }),
    // Proxy API requests to backend
    proxy: {
      '/api': {
        target: 'http://192.168.86.190:3001',
        changeOrigin: true,
        secure: false,
        // Rewrite path: /api/health -> /health
        rewrite: (path) => path.replace(/^\/api/, ''),
      },
    },
  },
});
```

**Key Points:**
- `server.host: true` - Allows LAN access
- `server.port: 3000` - Frontend port
- `server.https` - Enabled when certificates exist
- `server.proxy['/api']` - Proxies `/api/*` to `http://192.168.86.190:3001`
- Path rewrite removes `/api` prefix before forwarding

---

### B) Frontend API Client Update

**File: `services/api.ts`**

**Change in `getBaseUrl()` function (development mode):**

```typescript
// Development mode: Use relative /api paths (proxied by Vite to backend)
// This ensures same-origin requests, avoids CORS, and prevents mixed-content issues
// Vite proxy handles: /api/* -> http://192.168.86.190:3001/*
cachedBaseUrl = '/api';
```

**Result:**
- All API calls become: `fetch('/api/health')`, `fetch('/api/tts', ...)`, `fetch('/api/shadow', ...)`
- Requests go through Vite proxy (same-origin)
- No CORS issues, no mixed-content warnings
- Shadow uses the same API client as Hear AI

---

### C) Windows mkcert Setup Commands

**Step 1: Install mkcert**

**Option A: Chocolatey (recommended)**
```powershell
choco install mkcert
```

**Option B: Winget**
```powershell
winget install FiloSottile.mkcert
```

**Option C: Manual**
1. Download: https://github.com/FiloSottile/mkcert/releases
2. Extract `mkcert-v1.4.4-windows-amd64.exe` to a folder in PATH
3. Rename to `mkcert.exe`

**Step 2: Install Local CA (one-time)**
```powershell
mkcert -install
```

Expected output:
```
Created a new local CA at "C:\Users\YourName\AppData\Local\mkcert" 
The local CA is now installed in the system trust store! âš¡
```

**Step 3: Generate Certificates**
```powershell
cd D:\app\zaban\zaban2

# Create certs directory
mkdir certs

# Generate certificate for localhost and LAN IP
mkcert -key-file certs/localhost+2-key.pem -cert-file certs/localhost+2.pem localhost 127.0.0.1 192.168.86.190
```

**Note:** Replace `192.168.86.190` with your actual LAN IP if different.

Expected output:
```
Created a new certificate valid for the following names ğŸ“œ
 - "localhost"
 - "127.0.0.1"
 - "192.168.86.190"

The certificate is at "certs/localhost+2.pem" and the key at "certs/localhost+2-key.pem" âœ…
```

**Step 4: Verify .gitignore**
```powershell
# Check if certs/ is in .gitignore (should already be there)
cat .gitignore | findstr certs
```

If not present, add it:
```powershell
echo "certs/" >> .gitignore
```

---

### D) Run Commands

**Terminal 1: Backend**
```powershell
cd D:\app\zaban\zaban2\backend
npm run dev
```

Expected: Backend running on `http://192.168.86.190:3001` (or `http://localhost:3001`)

**Terminal 2: Frontend (HTTPS)**
```powershell
cd D:\app\zaban\zaban2
npm run dev
```

Expected output:
```
VITE v5.x.x  ready in xxx ms

âœ  Local:   https://localhost:3000/
âœ  Network: https://192.168.86.190:3000/
```

**Note:** If you see HTTP URLs instead of HTTPS, certificates are missing. Check `certs/` directory.

---

## Manual Test Checklist

### Test 1: Desktop, LAN IP (HTTPS)
- [ ] Open `https://192.168.86.190:3000` in browser
- [ ] **Accept certificate warning** (first time only - click "Advanced" â†’ "Proceed to 192.168.86.190")
- [ ] Browser asks for microphone permission â†’ **Allow**
- [ ] Click **Shadow** button
- [ ] Recording starts successfully (no "Microphone API not available" error)
- [ ] Verify console shows: `[SHADOW] Starting recording...` (no error)
- [ ] Recording works (can record and playback)

### Test 2: Desktop, Localhost (HTTPS)
- [ ] Open `https://localhost:3000` in browser
- [ ] Accept certificate warning (first time only)
- [ ] Click **Shadow** button
- [ ] Recording works successfully

### Test 3: Phone, LAN IP (HTTPS)
- [ ] On phone browser, open `https://192.168.86.190:3000`
- [ ] **Accept certificate warning** (tap "Advanced" â†’ "Proceed to 192.168.86.190")
- [ ] Browser asks for microphone permission â†’ **Allow**
- [ ] Click **Shadow** button
- [ ] Recording works successfully

### Test 4: API Proxy Verification
- [ ] Open browser DevTools â†’ Network tab
- [ ] Navigate to `https://192.168.86.190:3000`
- [ ] Check API request to `/api/health`:
  - [ ] **Status**: 200 OK
  - [ ] **URL**: `https://192.168.86.190:3000/api/health` (same origin)
  - [ ] **No CORS errors**
  - [ ] **No mixed-content warnings**
- [ ] Verify response contains: `{"ok": true}`

### Test 5: Hear AI Still Works
- [ ] Open `https://192.168.86.190:3000`
- [ ] Click **Hear AI** button
- [ ] Audio plays successfully
- [ ] No API errors in console

### Test 6: Backward Compatibility (HTTP)
- [ ] **Temporarily rename `certs/` to `certs-backup/`**
- [ ] Restart Vite dev server
- [ ] Open `http://localhost:3000` (HTTP)
- [ ] Verify app still works (Hear AI, etc.)
- [ ] **Rename back to `certs/`** and restart

---

## Troubleshooting

### Issue: "Certificates not found" / Vite serves HTTP

**Check:**
1. Certificates exist: `ls certs/` (should show both `.pem` files)
2. File names match exactly: `localhost+2-key.pem` and `localhost+2.pem`
3. Directory is `certs/` (not `.cert/`)
4. Restart Vite dev server after generating certificates

### Issue: "Certificate not trusted" warning

**Solution:**
1. Run `mkcert -install` again
2. Restart browser completely
3. Clear browser cache if needed
4. On phone: Tap "Advanced" â†’ "Proceed" (expected on first visit)

### Issue: "Mixed Content" errors

**Check:**
1. Frontend is HTTPS (check URL bar - should show `https://`)
2. API client uses `/api` paths (check console logs)
3. Vite proxy is working (check Network tab - requests should be same-origin)

### Issue: Microphone still blocked

**Check:**
1. URL is `https://...` (not `http://...`)
2. Not using `localhost` or `127.0.0.1`? Those work on HTTP too, but LAN IP needs HTTPS
3. Browser permissions: Settings â†’ Site Settings â†’ Microphone â†’ Allow
4. Check console for specific error messages
5. Verify certificate is trusted (no red lock icon)

### Issue: Backend CORS errors

**Check:**
1. Backend CORS allows HTTPS origins (already updated in `server.js`)
2. Backend is running on port 3001
3. Vite proxy target is correct: `http://192.168.86.190:3001`
4. Check backend logs for CORS errors

### Issue: API calls fail (404 or connection error)

**Check:**
1. Backend is running on `http://192.168.86.190:3001`
2. Vite proxy target matches backend address
3. Check Network tab - requests should go to `/api/*` (same origin)
4. Verify backend routes don't require `/api` prefix (proxy removes it)

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (HTTPS)                      â”‚
â”‚  https://192.168.86.190:3000                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Frontend (React/Vite)                            â”‚  â”‚
â”‚  â”‚  - getUserMedia() âœ… (secure context)            â”‚  â”‚
â”‚  â”‚  - API calls: fetch('/api/health')               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Same-origin requests (/api/*)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Vite Dev Server (HTTPS)                    â”‚
â”‚  https://192.168.86.190:3000                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Proxy: /api/* â†’ http://192.168.86.190:3001/*   â”‚  â”‚
â”‚  â”‚  - Rewrites: /api/health â†’ /health              â”‚  â”‚
â”‚  â”‚  - changeOrigin: true                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ HTTP (proxied)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend Server (HTTP)                      â”‚
â”‚  http://192.168.86.190:3001                            â”‚
â”‚                                                          â”‚
â”‚  - Express server                                       â”‚
â”‚  - CORS allows HTTPS origins                           â”‚
â”‚  - Routes: /health, /tts, /auth, etc.                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Browser only sees HTTPS (same-origin)
- Vite proxy handles HTTP â†’ HTTPS translation
- No mixed-content, no CORS issues
- Microphone API works (secure context)

---

## Files Changed

1. âœ… `vite.config.ts` - HTTPS + proxy configuration
2. âœ… `services/api.ts` - Use `/api` base in dev mode
3. âœ… `backend/server.js` - CORS allows HTTPS origins
4. âœ… `.gitignore` - Excludes `certs/` directory
5. âœ… `SHADOW_HTTPS_FIX.md` - This document

---

## Summary

âœ… **HTTPS enabled** on Vite dev server (when certificates present)  
âœ… **Proxy configured** `/api/*` â†’ `http://192.168.86.190:3001`  
âœ… **API client** uses relative `/api` paths in dev  
âœ… **Backend unchanged** (still HTTP, no HTTPS needed)  
âœ… **Shadow works** on LAN IP via HTTPS  
âœ… **Backward compatible** (falls back to HTTP if no certs)

**Result:** Shadow microphone recording now works on `https://192.168.86.190:3000` from any device on the LAN! ğŸ¤âœ…

