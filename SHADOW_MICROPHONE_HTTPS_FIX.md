# Shadow Microphone HTTPS Fix - Complete Implementation Guide

## Root Cause Explanation

**Browser Security Rule:** Microphone APIs (`navigator.mediaDevices.getUserMedia()` and `MediaRecorder`) require a **secure context**. Browsers define secure contexts as:
- âœ… `https://` URLs (any origin)
- âœ… `http://localhost` (special exception)
- âœ… `http://127.0.0.1` (special exception)
- âŒ `http://192.168.x.x` (LAN IPs are **NOT** secure)

**Why Shadow Fails on LAN IP:**
- `http://192.168.86.190:3000` is **not** a secure context
- Browser blocks `getUserMedia()` calls
- This is **expected browser security behavior**
- No code changes can bypass this - only HTTPS solves it

**Why localhost Works:**
- Browsers grant `localhost` a special secure exception for development
- This exception does **NOT** extend to LAN IPs

---

## Solution: HTTPS with Vite Proxy

**Architecture:**
1. Frontend serves over HTTPS: `https://192.168.86.190:3000`
2. Vite proxies `/api/*` â†’ `http://192.168.86.190:3001` (backend stays HTTP)
3. All browser requests are same-origin HTTPS (no mixed-content)
4. Microphone API works because HTTPS provides secure context

---

## Code Patches

### 1. vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// HTTPS certificate paths (generated by mkcert)
const CERT_DIR = path.resolve(__dirname, 'certs');
const KEY_PATH = path.join(CERT_DIR, 'localhost+2-key.pem');
const CERT_PATH = path.join(CERT_DIR, 'localhost+2.pem');

// Check if certificates exist
const hasCertificates = fs.existsSync(KEY_PATH) && fs.existsSync(CERT_PATH);

export default defineConfig({
  plugins: [react()],
  server: {
    host: true,        // Allow LAN access
    port: 3000,       // Frontend port
    // Enable HTTPS if certificates are available
    ...(hasCertificates && {
      https: {
        key: fs.readFileSync(KEY_PATH),
        cert: fs.readFileSync(CERT_PATH),
      },
    }),
    // Proxy API requests to backend
    proxy: {
      '/api': {
        target: 'http://192.168.86.190:3001',
        changeOrigin: true,
        secure: false,
        // Rewrite path: /api/health -> /health
        rewrite: (path) => path.replace(/^\/api/, ''),
      },
    },
  },
});
```

**Key Points:**
- `server.host: true` - Enables LAN access
- `server.port: 3000` - Frontend port
- `server.https` - Enabled when certificates exist (auto-detection)
- `server.proxy['/api']` - Proxies `/api/*` to backend, removes `/api` prefix

---

### 2. services/api.ts

**Change in `getBaseUrl()` function (development mode section):**

```typescript
// Development mode: Use relative /api paths (proxied by Vite to backend)
// This ensures same-origin requests, avoids CORS, and prevents mixed-content issues
// Vite proxy handles: /api/* -> http://192.168.86.190:3001/*
cachedBaseUrl = '/api';
```

**Result:**
- All API calls become relative: `fetch('/api/health')`, `fetch('/api/tts')`, etc.
- Requests go through Vite proxy (same-origin HTTPS)
- No direct calls to `http://192.168.86.190:3001` from browser
- Shadow and Hear AI share the same API client

**Full function context:**
```typescript
export function getBaseUrl(): string {
  // ... production mode check ...
  
  // Development mode
  if (typeof window === 'undefined') {
    throw new Error('getBaseUrl() must be called from browser context in development mode.');
  }
  
  // Development mode: Use relative /api paths (proxied by Vite to backend)
  cachedBaseUrl = '/api';
  
  // ... logging ...
  return cachedBaseUrl;
}
```

---

### 3. .gitignore

```
certs/
```

---

## mkcert Setup Steps (Windows)

### Step 1: Install mkcert

**Option A: Chocolatey (recommended)**
```powershell
choco install mkcert
```

**Option B: Winget**
```powershell
winget install FiloSottile.mkcert
```

**Option C: Manual**
1. Download: https://github.com/FiloSottile/mkcert/releases
2. Extract `mkcert-v1.4.4-windows-amd64.exe` to a folder in PATH
3. Rename to `mkcert.exe`

### Step 2: Install Local CA (one-time)

```powershell
mkcert -install
```

**Expected output:**
```
Created a new local CA at "C:\Users\YourName\AppData\Local\mkcert" 
The local CA is now installed in the system trust store! âš¡
```

### Step 3: Generate Certificates

```powershell
cd D:\app\zaban\zaban2

# Create certs directory
mkdir certs

# Generate certificate for localhost, 127.0.0.1, and LAN IP
mkcert -key-file certs/localhost+2-key.pem -cert-file certs/localhost+2.pem localhost 127.0.0.1 192.168.86.190
```

**Expected output:**
```
Created a new certificate valid for the following names ğŸ“œ
 - "localhost"
 - "127.0.0.1"
 - "192.168.86.190"

The certificate is at "certs/localhost+2.pem" and the key at "certs/localhost+2-key.pem" âœ…
```

**Note:** Replace `192.168.86.190` with your actual LAN IP if different.

### Step 4: Verify .gitignore

```powershell
# Check if certs/ is already in .gitignore
cat .gitignore | findstr certs
```

If not present, add it:
```powershell
echo "certs/" >> .gitignore
```

---

## Run Commands

### Terminal 1: Backend
```powershell
cd D:\app\zaban\zaban2\backend
npm run dev
```

**Expected:** Backend running on `http://192.168.86.190:3001` (or `http://localhost:3001`)

### Terminal 2: Frontend (HTTPS)
```powershell
cd D:\app\zaban\zaban2
npm run dev
```

**Expected output:**
```
VITE v5.x.x  ready in xxx ms

âœ  Local:   https://localhost:3000/
âœ  Network: https://192.168.86.190:3000/
```

**Note:** If you see HTTP URLs instead of HTTPS, certificates are missing. Check `certs/` directory.

---

## Manual Test Checklist

### âœ… Test 1: Desktop, LAN IP (HTTPS)

**Steps:**
1. Open `https://192.168.86.190:3000` in browser
2. **Accept certificate warning** (first time only):
   - Click "Advanced" or "Show Details"
   - Click "Proceed to 192.168.86.190 (unsafe)" or similar
3. Browser prompts for microphone permission â†’ **Allow**
4. Click **Shadow** button
5. Recording starts successfully

**Expected Results:**
- âœ… No "Microphone API not available" error in console
- âœ… Console shows: `[SHADOW] Starting recording...`
- âœ… Microphone permission prompt appears
- âœ… Recording works (can record and playback)
- âœ… Network tab shows requests to `/api/*` (same origin, HTTPS)

**Console Check:**
```
[API Base] Development mode: {
  pageHostname: "192.168.86.190",
  pageProtocol: "https:",
  apiBase: "/api",
  note: "Using relative /api paths (proxied by Vite to http://192.168.86.190:3001)"
}
```

---

### âœ… Test 2: Phone, LAN IP (HTTPS)

**Steps:**
1. On phone browser, open `https://192.168.86.190:3000`
2. **Accept certificate warning**:
   - Tap "Advanced" or "Details"
   - Tap "Proceed to 192.168.86.190" or "Continue"
3. Browser prompts for microphone permission â†’ **Allow**
4. Click **Shadow** button
5. Recording works

**Expected Results:**
- âœ… Shadow recording works on phone
- âœ… No microphone errors
- âœ… API calls work (Hear AI also works)

---

### âœ… Test 3: Localhost (HTTP - Still Works)

**Steps:**
1. Open `http://localhost:3000` in browser
2. Click **Shadow** button
3. Recording works

**Expected Results:**
- âœ… Shadow works on localhost (secure context exception)
- âœ… No certificate warning (HTTP is fine for localhost)
- âœ… API calls work (may use direct backend connection or proxy)

---

### âœ… Test 4: API Proxy Verification

**Steps:**
1. Open `https://192.168.86.190:3000`
2. Open browser DevTools â†’ **Network** tab
3. Navigate to app (triggers API calls)
4. Check `/api/health` request

**Expected Results:**
- âœ… **Status**: 200 OK
- âœ… **URL**: `https://192.168.86.190:3000/api/health` (same origin)
- âœ… **Type**: `fetch` or `xhr`
- âœ… **No CORS errors** in console
- âœ… **No mixed-content warnings** in console
- âœ… Response: `{"ok": true}`

**Network Tab Details:**
```
Request URL: https://192.168.86.190:3000/api/health
Request Method: GET
Status Code: 200 OK
Remote Address: 192.168.86.190:3000
```

---

### âœ… Test 5: Hear AI Still Works

**Steps:**
1. Open `https://192.168.86.190:3000`
2. Click **Hear AI** button
3. Audio plays

**Expected Results:**
- âœ… Hear AI works (no API errors)
- âœ… Audio plays successfully
- âœ… Console shows no errors

---

## Troubleshooting

### Issue: "Certificates not found" / Vite serves HTTP

**Symptoms:**
- Vite shows `http://` URLs instead of `https://`
- Console shows HTTP protocol

**Solution:**
1. Check certificates exist: `ls certs/` (should show both `.pem` files)
2. Verify file names: `localhost+2-key.pem` and `localhost+2.pem`
3. Check directory is `certs/` (not `.cert/`)
4. Restart Vite dev server after generating certificates

---

### Issue: "Certificate not trusted" warning

**Symptoms:**
- Browser shows "Your connection is not private" or "NET::ERR_CERT_AUTHORITY_INVALID"
- Red lock icon in address bar

**Solution:**
1. Run `mkcert -install` again
2. Restart browser completely
3. Clear browser cache if needed
4. On first visit, click "Advanced" â†’ "Proceed" (expected behavior)

---

### Issue: "Mixed Content" errors

**Symptoms:**
- Console shows "Mixed Content" warnings
- API calls fail

**Solution:**
1. Verify frontend is HTTPS (check URL bar - should show `https://`)
2. Check API client uses `/api` paths (check console logs)
3. Verify Vite proxy is working (check Network tab - requests should be same-origin)
4. Ensure no direct calls to `http://192.168.86.190:3001` in code

---

### Issue: Microphone still blocked

**Symptoms:**
- "Microphone API not available" error persists
- No microphone permission prompt

**Solution:**
1. Verify URL is `https://...` (not `http://...`)
2. Check browser permissions: Settings â†’ Site Settings â†’ Microphone â†’ Allow
3. Check console for specific error messages
4. Verify certificate is trusted (no red lock icon)
5. Try incognito/private mode to reset permissions

---

### Issue: Backend CORS errors

**Symptoms:**
- Console shows CORS errors
- API calls fail with CORS-related messages

**Solution:**
1. Verify backend CORS allows HTTPS origins (already updated in `server.js`)
2. Check backend is running on port 3001
3. Verify Vite proxy target is correct: `http://192.168.86.190:3001`
4. Check backend logs for CORS errors

---

### Issue: API calls return 404

**Symptoms:**
- API calls return 404 Not Found
- Network tab shows 404 status

**Solution:**
1. Verify backend is running on `http://192.168.86.190:3001`
2. Check Vite proxy target matches backend address
3. Verify backend routes don't require `/api` prefix (proxy removes it)
4. Test backend directly: `curl http://192.168.86.190:3001/health`

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (HTTPS)                      â”‚
â”‚  https://192.168.86.190:3000                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Frontend (React/Vite)                            â”‚  â”‚
â”‚  â”‚  - getUserMedia() âœ… (secure context)            â”‚  â”‚
â”‚  â”‚  - API calls: fetch('/api/health')               â”‚  â”‚
â”‚  â”‚  - Shadow: navigator.mediaDevices.getUserMedia() â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Same-origin HTTPS requests (/api/*)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Vite Dev Server (HTTPS)                     â”‚
â”‚  https://192.168.86.190:3000                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Proxy: /api/* â†’ http://192.168.86.190:3001/*   â”‚  â”‚
â”‚  â”‚  - Rewrites: /api/health â†’ /health              â”‚  â”‚
â”‚  â”‚  - changeOrigin: true                           â”‚  â”‚
â”‚  â”‚  - secure: false                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ HTTP (proxied, server-side)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend Server (HTTP)                     â”‚
â”‚  http://192.168.86.190:3001                            â”‚
â”‚                                                          â”‚
â”‚  - Express server                                       â”‚
â”‚  - CORS allows HTTPS origins                           â”‚
â”‚  - Routes: /health, /tts, /auth, etc.                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Browser only sees HTTPS (same-origin)
- Vite proxy handles HTTP â†’ HTTPS translation
- No mixed-content, no CORS issues
- Microphone API works (secure context provided by HTTPS)

---

## Summary

âœ… **HTTPS enabled** on Vite dev server (when certificates present)  
âœ… **Proxy configured** `/api/*` â†’ `http://192.168.86.190:3001`  
âœ… **API client** uses relative `/api` paths in dev  
âœ… **Backend unchanged** (still HTTP, no HTTPS needed)  
âœ… **Shadow works** on LAN IP via HTTPS  
âœ… **Backward compatible** (falls back to HTTP if no certs, localhost still works)

**Result:** Shadow microphone recording now works on `https://192.168.86.190:3000` from any device on the LAN! ğŸ¤âœ…

